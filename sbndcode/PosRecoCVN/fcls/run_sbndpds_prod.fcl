#include "services_sbnd.fcl"
#include "simulationservices_sbnd.fcl"
#include "messages_sbnd.fcl"
#include "sam_sbnd.fcl"

process_name: SBNDPDSProd

services:
{
  TFileService:              { fileName: "ttree_analysis.root" }
  @table::sbnd_basic_services
  @table::sbnd_simulation_services
  ParticleInventoryService: @local::sbnd_particleinventoryservice
  BackTrackerService:       @local::sbnd_backtrackerservice
  ParticleInventoryService: @local::standard_particleinventoryservice
}

source:
{
  module_type: RootInput
  maxEvents:  -1  # Number of events to create
}

physics:
{
  producers:
  {
    opanatree: {
      module_type: "SBNDPDSProducer"
      Verbosity: 0
      MCTruthModuleLabel: ["generator"]
      MCTruthInstanceLabel: [""]
      MCTruthOrigin: [1, 4]  # BNB neutrinos and single particles
      MCTruthPDG: [12, 14, -12, -14]  # neutrinos
      MCModuleLabel: "largeant"
      OpHitsModuleLabel: ["ophitpmt","ophitxarapuca"]
      OpFlashesModuleLabel: ["opflashtpc0", "opflashtpc1", "opflashtpc0xarapuca", "opflashtpc1xarapuca"]
      G4BufferBoxX: [-300, 300] #cm
      G4BufferBoxY: [-400, 400] #cm
      G4BufferBoxZ: [-100, 600] #cm
      G4BeamWindow: [-10000, 12000] #ns
      KeepPDGCode: []  # empty = keep all particles
      SaveOpHits: true
      
      # PMT Map Configuration (grid)

      #CoatedPMTMapPath: "sbndcode/v10_09_00/scripts/PosRecoCVN/pmt_maps/coated_pmt_map_realistic_flipped.csv"
      #UncoatedPMTMapPath: "sbndcode/v10_09_00/scripts/PosRecoCVN/pmt_maps/uncoated_pmt_map_realistic_flipped.csv"

      # PMT Map Configuration (local)

      CoatedPMTMapPath: "/exp/sbnd/app/users/svidales/larsoft_develop/localProducts_larsoft_v10_09_00_e26_prof/sbndcode/v10_09_00/scripts/PosRecoCVN/pmt_maps/coated_pmt_map_realistic_flipped.csv"
      UncoatedPMTMapPath: "/exp/sbnd/app/users/svidales/larsoft_develop/localProducts_larsoft_v10_09_00_e26_prof/sbndcode/v10_09_00/scripts/PosRecoCVN/pmt_maps/uncoated_pmt_map_realistic_flipped.csv"

      # TensorFlow Configuration
      RunInference: true
      #ModelPath: "sbndcode/v10_09_00/scripts/PosRecoCVN/inference/tf/v0901_trained_w_165k_resnet18/saved_model/" #(grid)
      ModelPath: "/exp/sbnd/app/users/svidales/larsoft_develop/localProducts_larsoft_v10_09_00_e26_prof/sbndcode/v10_09_00/scripts/PosRecoCVN/inference/tf/v0901_trained_w_165k_resnet18/saved_model" #(local)
      InputNames: []
      OutputNames: []
      
      # Image Normalization Configuration
      # Value from: sbndcode/v10_09_00/scripts/PosRecoCVN/inference/tf/v0901_trained_w_165k_resnet18/normalization_factors.json
      CustomNormFactor: 11311.19140625
    }
  }

  # Definir paths
  prod: [opanatree]
  stream: [out1]
  
  # Configurar trigger_paths y end_paths
  trigger_paths: [prod]
  end_paths: [stream]
}

outputs:
{
  out1:
  {
    module_type: RootOutput
    fileName: "pixelmap_variables.root"
    dataTier: "reconstructed"
    streamName: "out"
    outputCommands: [
      "drop *",
      "keep PixelMapVars_opanatree__SBNDPDSProd*",
      "keep *_TFileService_*_*"
    ]
  }
}

